
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="['LemurPwned']">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-8.1.2">
    
    
      
        <title>Parallelism - CMTJ</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.f7951f6f.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#parallelism-in-cmtj" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="CMTJ" class="md-header__button md-logo" aria-label="CMTJ" data-md-component="logo">
      
  <img src="../../assets/icon.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            CMTJ
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Parallelism
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/LemurPwned/cmtj" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2z"/></svg>
  </div>
  <div class="md-source__repository">
    LemurPwned/cmtj
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="CMTJ" class="md-nav__button md-logo" aria-label="CMTJ" data-md-component="logo">
      
  <img src="../../assets/icon.svg" alt="logo">

    </a>
    CMTJ
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/LemurPwned/cmtj" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2z"/></svg>
  </div>
  <div class="md-source__repository">
    LemurPwned/cmtj
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Theory
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Theory" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Theory
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../contributions/" class="md-nav__link">
        Macromagnetic contributions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../macromagnetic_models/" class="md-nav__link">
        LLG Equation & solvers
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Parallelism
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Parallelism
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    Overview
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#general-caveats" class="md-nav__link">
    General caveats
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#problem-description" class="md-nav__link">
    Problem description
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#parallelising-the-vsd-experiment" class="md-nav__link">
    Parallelising the VSD experiment
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          API
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="API" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          API
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../gen-docs/cmtj/" class="md-nav__link">
        Core
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_2" type="checkbox" id="__nav_5_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5_2">
          Models
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Models" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_2">
          <span class="md-nav__icon md-icon"></span>
          Models
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/models/sb-reference/" class="md-nav__link">
        Smit-Beljers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/models/dw-reference/" class="md-nav__link">
        Domain wall
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_3" type="checkbox" id="__nav_5_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5_3">
          Utils
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Utils" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_3">
          <span class="md-nav__icon md-icon"></span>
          Utils
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/general-reference/" class="md-nav__link">
        General
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/linear-reference/" class="md-nav__link">
        Linear
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/filters-reference/" class="md-nav__link">
        Filters
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/energy-reference/" class="md-nav__link">
        Energy
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/plotting-reference/" class="md-nav__link">
        Plotting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/procedures-reference/" class="md-nav__link">
        Procedures
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/parallel-reference/" class="md-nav__link">
        Parallel
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../gen-docs/stack/" class="md-nav__link">
        Stack
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          Examples
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Examples" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Examples
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../CMTJBindingsTutorial/" class="md-nav__link">
        Library introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../trajectory/" class="md-nav__link">
        Generating trajectories
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    Overview
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#general-caveats" class="md-nav__link">
    General caveats
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#problem-description" class="md-nav__link">
    Problem description
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#parallelising-the-vsd-experiment" class="md-nav__link">
    Parallelising the VSD experiment
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
<a href="https://github.com/LemurPwned/cmtj/edit/master/docs/physics/paralellism.md" title="Edit this page" class="md-content__button md-icon">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
</a>


<h1 id="parallelism-in-cmtj">Parallelism in CMTJ</h1>
<h2 id="overview">Overview</h2>
<p><code>cmtj</code> provides a simple way to parallelise simulation sweeps. For instance, while performing the Voltage Spin Diode (VSD) experiments, we need to sweep the frequency and for each frequency value we further need to sweep with the field. For each field and frequency pair we need to compute the VSD DC resistance. Normally, this scales as <span class="arithmatex">\(O(NK)\)</span> where <span class="arithmatex">\(N\)</span> is the number of field values and <span class="arithmatex">\(K\)</span> is the number of frequency values. However, with parallelism, we can reduce this to <span class="arithmatex">\(O(K)\)</span> if we would be able to process each frequency value in parallel.</p>
<p>In practice, we use worker pools which are approximately equal to the number of threads in the CPU. Each worker is assigned a frequency value and it computes the VSD DC resistance for all the field values. Whenever the worker is finished, it is assigned another frequency value.</p>
<h2 id="general-caveats">General caveats</h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Keep in mind that these issues are not specific to CMTJ, but are a general problem of any parallelisation.</p>
</div>
<p>Before we move on to a specific example, let's discuss when we should be careful with simulating in parallel.
When we sweep with an external field, which in the experiment is usually continously swept, we need to realise that if we were to compute the experiment for each separate field in a separate process, we would not carry the relaxed state of magnetisation computed in the previous field step to the next. This is of course a natural consequence of putting things in parallel and can be easily remedided by the following precautions:</p>
<ul>
<li>relax the magnetisation the magentisation in each parallel process by calling <code>runSimulation</code> for a short time, say between 1-5ns (depending on the complexity of the system),</li>
<li>increase the simulation time, since reaching the stable state may take a little longer,</li>
<li>decrease the time step (integration step) -- this is more costly computationally, but it is also ensuring absolute convergence.</li>
</ul>
<p>We generally recommend to use the <code>runSimulation</code> function to relax the magnetisation in each parallel process, and then to use the <code>runSimulation</code> function to compute the experiment in parallel. This is the most efficient way to do it, since short relaxation period does not incur a large computational cost, and because we paralellise the experiment anyway, that cost is offset by running on multiple threads.</p>
<p>With this in mind, let's move on to a specific example.</p>
<h2 id="problem-description">Problem description</h2>
<p>Suppose we want to compute the VSD DC resistance for a given frequency and field value, but also check how the VSD spectra differ for different values of the interlayer exchange coupling (IEC) constant <code>J</code>.
What we want to effectively do is we want to fun a VSD experiment for each of the <code>J</code> values, wherein each experiment is a function of the frequency and field.
Below, we outline the steps to parallelise such a problem.</p>
<h2 id="parallelising-the-vsd-experiment">Parallelising the VSD experiment</h2>
<p>Here's what we need:</p>
<ul>
<li>A function that computes the VSD DC resistance for a given frequency and field value.</li>
<li>A range of frequencies and fields.</li>
<li>A distributing function that assigns the frequency and field values to the workers.</li>
</ul>
<p>The last point is taken care of by importing the <code>distribute</code> function from <code>cmtj.utils.parallel</code>. The <code>distribute</code> function takes a function and a list of arguments and distributes the arguments to the workers.</p>
<p>An example function that computes the VSD DC resistance for a given system with a IEC constant <code>J</code> and for a specific frequency and field value:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">simulate_vsd</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">frequency</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function computes the VSD DC resistance for a</span>
<span class="sd">    given frequency f and field value H.</span>
<span class="sd">    It also takes the current coupling value J as an argument.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">int_step</span> <span class="o">=</span> <span class="mf">5e-13</span>
    <span class="n">demag</span> <span class="o">=</span> <span class="p">[</span><span class="n">CVector</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CVector</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">CVector</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>

    <span class="n">Ku</span> <span class="o">=</span> <span class="mf">0.8e3</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.024</span>  <span class="c1"># 0.024</span>
    <span class="n">l1</span> <span class="o">=</span> <span class="n">Layer</span><span class="p">(</span>
        <span class="s2">&quot;free&quot;</span><span class="p">,</span>
        <span class="n">mag</span><span class="o">=</span><span class="n">CVector</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
        <span class="n">anis</span><span class="o">=</span><span class="n">CVector</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">),</span>  <span class="c1"># direction of the anisotropy</span>
        <span class="n">Ms</span><span class="o">=</span><span class="mf">1.03</span><span class="p">,</span>
        <span class="n">thickness</span><span class="o">=</span><span class="mf">2.1e-9</span><span class="p">,</span>
        <span class="n">cellSurface</span><span class="o">=</span><span class="n">surf</span><span class="p">,</span>
        <span class="n">demagTensor</span><span class="o">=</span><span class="n">demag</span><span class="p">,</span>
        <span class="n">damping</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>

    <span class="n">l2</span> <span class="o">=</span> <span class="n">Layer</span><span class="p">(</span>
        <span class="s2">&quot;bottom&quot;</span><span class="p">,</span>
        <span class="n">mag</span><span class="o">=</span><span class="n">CVector</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
        <span class="n">anis</span><span class="o">=</span><span class="n">CVector</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="c1"># direction of the anisotropy</span>
        <span class="n">Ms</span><span class="o">=</span><span class="mf">1.65</span><span class="p">,</span>
        <span class="n">thickness</span><span class="o">=</span><span class="mf">6e-9</span><span class="p">,</span>
        <span class="n">cellSurface</span><span class="o">=</span><span class="n">surf</span><span class="p">,</span>
        <span class="n">demagTensor</span><span class="o">=</span><span class="n">demag</span><span class="p">,</span>
        <span class="n">damping</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
    <span class="n">j1</span> <span class="o">=</span> <span class="n">Junction</span><span class="p">([</span><span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">],</span> <span class="mf">163.5</span><span class="p">,</span> <span class="mi">176</span><span class="p">)</span>
    <span class="n">j1</span><span class="o">.</span><span class="n">setLayerAnisotropyDriver</span><span class="p">(</span><span class="s2">&quot;free&quot;</span><span class="p">,</span> <span class="n">ScalarDriver</span><span class="o">.</span><span class="n">getConstantDriver</span><span class="p">(</span><span class="n">Ku</span><span class="p">))</span>
    <span class="n">j1</span><span class="o">.</span><span class="n">setLayerAnisotropyDriver</span><span class="p">(</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="n">ScalarDriver</span><span class="o">.</span><span class="n">getConstantDriver</span><span class="p">(</span><span class="mf">1e12</span><span class="p">))</span>
    <span class="n">j1</span><span class="o">.</span><span class="n">setIECDriver</span><span class="p">(</span><span class="s2">&quot;free&quot;</span><span class="p">,</span> <span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="n">ScalarDriver</span><span class="o">.</span><span class="n">getConstantDriver</span><span class="p">(</span><span class="n">J</span><span class="p">))</span>
    <span class="n">hangle</span> <span class="o">=</span> <span class="n">FieldScan</span><span class="o">.</span><span class="n">angle2vector</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="n">H</span><span class="p">)</span>
    <span class="n">j1</span><span class="o">.</span><span class="n">clearLog</span><span class="p">()</span>
    <span class="n">j1</span><span class="o">.</span><span class="n">setLayerExternalFieldDriver</span><span class="p">(</span>
        <span class="s2">&quot;all&quot;</span><span class="p">,</span>
        <span class="n">AxialDriver</span><span class="p">(</span><span class="n">ScalarDriver</span><span class="o">.</span><span class="n">getConstantDriver</span><span class="p">(</span><span class="n">hangle</span><span class="o">.</span><span class="n">x</span><span class="p">),</span>
                    <span class="n">ScalarDriver</span><span class="o">.</span><span class="n">getConstantDriver</span><span class="p">(</span><span class="n">hangle</span><span class="o">.</span><span class="n">y</span><span class="p">),</span>
                    <span class="n">ScalarDriver</span><span class="o">.</span><span class="n">getConstantDriver</span><span class="p">(</span><span class="n">hangle</span><span class="o">.</span><span class="n">z</span><span class="p">)))</span>
    <span class="n">j1</span><span class="o">.</span><span class="n">setLayerOerstedFieldDriver</span><span class="p">(</span>
        <span class="s2">&quot;free&quot;</span><span class="p">,</span>
        <span class="n">AxialDriver</span><span class="p">(</span>
            <span class="n">NullDriver</span><span class="p">(),</span>
            <span class="n">ScalarDriver</span><span class="o">.</span><span class="n">getSineDriver</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">NullDriver</span><span class="p">(),</span>
        <span class="p">))</span>
    <span class="n">j1</span><span class="o">.</span><span class="n">runSimulation</span><span class="p">(</span><span class="mf">60e-9</span><span class="p">,</span> <span class="n">int_step</span><span class="p">,</span> <span class="n">int_step</span><span class="p">,</span> <span class="n">solverMode</span><span class="o">=</span><span class="n">SolverMode</span><span class="o">.</span><span class="n">RK4</span><span class="p">)</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">j1</span><span class="o">.</span><span class="n">getLog</span><span class="p">()</span>
    <span class="n">dynamicR</span> <span class="o">=</span> <span class="n">log</span><span class="p">[</span><span class="s1">&#39;R_free_bottom&#39;</span><span class="p">]</span>

    <span class="n">dynamicI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">frequency</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]))</span>
    <span class="n">vmix</span> <span class="o">=</span> <span class="n">compute_sd</span><span class="p">(</span><span class="n">dynamicR</span><span class="p">,</span> <span class="n">dynamicI</span><span class="p">,</span> <span class="n">int_step</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">vmix</span>
</code></pre></div>
<p>Writing such functions is a good idea in general, since they can be also used in the normal serial processing as well. So a good practice is to write such a function first, test it in serial/iterative sweep and then use <code>distribute</code> to parallelise it easily. Here's how we would use the <code>distribute</code> function to parallelise the VSD experiment:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">cmtj.utils.parallel</span> <span class="kn">import</span> <span class="n">distribute</span>

<span class="n">Js</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1e-4</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">Hrange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">15e3</span><span class="p">,</span> <span class="mf">15e3</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">fscan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">1e9</span><span class="p">,</span> <span class="mf">6.2e9</span><span class="p">,</span> <span class="mf">0.2e9</span><span class="p">)</span>
<span class="n">VSD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">Js</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">fscan</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">Hrange</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">Js</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">Js</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
<span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">distribute</span><span class="p">(</span><span class="n">simulate_vsd</span><span class="p">,</span> <span class="p">[</span><span class="n">Js</span><span class="p">,</span> <span class="n">Hrange</span><span class="p">,</span> <span class="n">fscan</span><span class="p">]):</span>
    <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span> <span class="n">out</span> <span class="o">=</span> <span class="n">res</span>
    <span class="n">VSD</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span>
</code></pre></div>
<p>The <code>distribute</code> function returns a generator, which we can iterate over to get the results. The results are returned as a tuple of two elements: the first element is a tuple of the indices of the result, and the second element is the result itself. In our case, the result is the VSD DC resistance, and the indices are the indices of the <code>J</code>, <code>H</code> and <code>f</code> values (in that order specifically, we need to match the function signature of <code>simulate_vsd</code> with the second argument to <code>distribute</code> function). We can use these indices to assign the result to the correct place in the <code>VSD</code> array.</p>
<p>Very simple!
Now we can plot the VSD spectra for different values of the IEC constant <code>J</code>:</p>
<div class="highlight"><pre><span></span><code><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Js</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Js</span><span class="p">)):</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">pcolor</span><span class="p">(</span> <span class="n">Hrange</span><span class="o">/</span><span class="mf">1e3</span><span class="p">,</span> <span class="n">fscan</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">,</span> <span class="n">VSD</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;H (kA/m)&quot;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency (GHz)&quot;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;J = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Js</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
</code></pre></div>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../macromagnetic_models/" class="md-footer__link md-footer__link--prev" aria-label="Previous: LLG Equation &amp; solvers" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              LLG Equation & solvers
            </div>
          </div>
        </a>
      
      
        
        <a href="../../gen-docs/cmtj/" class="md-footer__link md-footer__link--next" aria-label="Next: Core" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Core
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.0bbba5b5.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.649a939e.min.js"></script>
      
        <script src="../../javascripts/config.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>